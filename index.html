<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Choir Practice Player</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      max-width: 900px; margin: auto; padding: 20px; line-height: 1.4; }
    /* Header & utility */
    #track-title { margin: 0 0 8px; text-align:center; }
    #timer { font-weight: 600; text-align:center; }
    /* Main controls */
    #main-controls { display:none; text-align:center; margin: 12px 0 18px; }
    #play-pause, #stop { padding: 12px 22px; font-size: 1.05rem; border:0; border-radius: 8px; cursor:pointer; margin: 0 6px; }
    #play-pause { background:#16a34a; color:#fff; }
    #play-pause[disabled] { opacity:.6; cursor:not-allowed; }
    #play-pause:hover { filter:brightness(.95); }
    #stop { background:#ef4444; color:#fff; }
    #stop[disabled]{ opacity:.6; cursor:not-allowed; }
    #stop:hover { filter:brightness(.95); }
    /* Jump & timeline */
    #jump-controls { display:none; text-align:center; margin-bottom:12px; }
    #timeline { display:none; margin: 10px 0 20px; height: 44px; background: #f3f4f6;
      position: relative; overflow-x:auto; white-space:nowrap; border:1px solid #e5e7eb; border-radius:10px; }
    .measure-tick { display:inline-block; height:100%; width:34px; position:relative; border-left:1px solid #e5e7eb; cursor:pointer; }
    .measure-tick span { position:absolute; bottom:2px; left:4px; font-size:10px; color:#374151; }
    #progress-bar { position:absolute; top:0; height:100%; width:2px; background:#1d4ed8; }
    /* Player rows */
    #player { display:none; }
    .track { display:flex; align-items:center; gap:12px; padding:8px 10px; border:1px solid #e5e7eb;
      border-radius:10px; background:#fafafa; margin-bottom:12px; }
    .track label { min-width:180px; max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:600; }
    .track .slider-wrap { flex:1; }
    .track input[type=range]{ width:100%; }
    .btn { border:1px solid #d1d5db; background:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; font-size:.9rem; }
    .btn:hover{ background:#f3f4f6; }
    .btn.solo.active { border-color:#2563eb; background:#e0ecff; }
    .btn.mute.active { border-color:#dc2626; background:#ffe2e2; }
    /* Password */
    #access-denied { color:#dc2626; font-weight:700; display:none; }
  </style>
</head>
<body>
  <h1 id="track-title">Close Every Door</h1>
  <div id="timer">Measure --, Beat --</div>

  <div id="main-controls">
    <button id="play-pause" disabled>Loadingâ€¦</button>
    <button id="stop" disabled>Stop</button>
  </div>

  <div id="jump-controls">
    <label for="jump-measure">Jump to measure:</label>
    <input type="number" id="jump-measure" min="1" max="127" />
    <button class="btn" onclick="jumpToMeasure()">Go</button>
  </div>

  <div id="timeline"><div id="progress-bar"></div></div>

  <div id="password-gate">
    <p>Enter password to access the choir tracks:</p>
    <input type="password" id="password-input" />
    <button class="btn" onclick="checkPassword()">Submit</button>
    <p id="access-denied">Access Denied</p>
  </div>

  <div id="player"></div>

  <script>
    const correctPassword = "sing123";

    const tracks = [
      { name: 'Accompaniment', url: 'assets/Accompaniment Close Every Door.wav' },
      { name: 'Joseph',        url: 'assets/Joseph Close Every Door.wav' },
      { name: 'S1',            url: 'assets/S1 Close Every Door.wav' },
      { name: 'S2',            url: 'assets/S2 Close Every Door.wav' },
      { name: 'Alto',          url: 'assets/Alto Close Every Door.wav' },
      { name: 'Tenor',         url: 'assets/Tenor Close Every Door.wav' },
      { name: 'Bass',          url: 'assets/Bass Close Every Door.wav' },
      { name: 'Choir 1',       url: 'assets/Choir 1 Close Every Door.wav' },
      { name: 'Choir 2',       url: 'assets/Choir 2 Close Every Door.wav' }
    ];

    const tempoMap = [ { measure: 0, beatsPerMeasure: 3, bpm: 80 } ];

    let audioContext;
    let sources = [];
    let channel = []; // {buffer, gain, slider, muteBtn, soloBtn, muted, solo}
    let startTime = 0;
    let duration = 0;
    let offset = 0;
    let isPlaying = false;

    function showAuthUI() {
      document.getElementById("main-controls").style.display = "block";
      document.getElementById("track-title").style.display = "block";
      document.getElementById("timer").style.display = "block";
      document.getElementById("timeline").style.display = "block";
      document.getElementById("jump-controls").style.display = "block";
      document.getElementById("player").style.display = "block";
    }

    function checkPassword() {
      const input = document.getElementById("password-input").value;
      if (input === correctPassword) {
        document.getElementById("password-gate").style.display = "none";
        showAuthUI();
        // Hook buttons immediately
        document.getElementById("play-pause").addEventListener("click", playPause);
        document.getElementById("stop").addEventListener("click", stopAll);
        initPlayer();
      } else {
        document.getElementById("access-denied").style.display = "block";
      }
    }

    async function initPlayer() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const playerDiv = document.getElementById("player");

      let loadedCount = 0;

      for (const track of tracks) {
        // Build row UI
        const row = document.createElement("div");
        row.className = "track";
        const label = document.createElement("label");
        label.textContent = track.name;

        const sliderWrap = document.createElement("div");
        sliderWrap.className = "slider-wrap";
        const slider = document.createElement("input");
        slider.type = "range"; slider.min = 0; slider.max = 1; slider.step = 0.01; slider.value = 1;
        sliderWrap.appendChild(slider);

        const muteBtn = document.createElement("button");
        muteBtn.className = "btn mute"; muteBtn.textContent = "Mute";
        const soloBtn = document.createElement("button");
        soloBtn.className = "btn solo"; soloBtn.textContent = "Solo";

        row.append(label, sliderWrap, muteBtn, soloBtn);
        playerDiv.appendChild(row);

        // Load audio defensively
        try {
          const resp = await fetch(track.url);
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const arr = await resp.arrayBuffer();
          const buffer = await audioContext.decodeAudioData(arr);

          const gain = audioContext.createGain();
          gain.gain.value = parseFloat(slider.value);

          const ch = { buffer, gain, slider, muteBtn, soloBtn, muted:false, solo:false };
          channel.push(ch);
          duration = Math.max(duration, buffer.duration);

          slider.addEventListener('input', () => updateMix());
          muteBtn.addEventListener('click', () => { ch.muted = !ch.muted; muteBtn.classList.toggle('active', ch.muted); updateMix(); });
          soloBtn.addEventListener('click', () => { ch.solo = !ch.solo; soloBtn.classList.toggle('active', ch.solo); updateMix(); });

          loadedCount++;
        } catch (e) {
          console.error(`Failed to load "${track.name}" (${track.url}):`, e);
          // Insert a tiny note so you know which track failed
          const errNote = document.createElement('small');
          errNote.textContent = ' (failed to load)';
          errNote.style.color = '#dc2626';
          label.appendChild(errNote);
        }
      }

      drawTimeline();
      updateMix();

      // Enable buttons if at least one track loaded
      const playBtn = document.getElementById("play-pause");
      const stopBtn  = document.getElementById("stop");
      if (loadedCount > 0) {
        playBtn.disabled = false; playBtn.textContent = "Play";
        stopBtn.disabled  = false;
      } else {
        playBtn.textContent = "No audio loaded";
      }
    }

    function updateMix() {
      const anySolo = channel.some(ch => ch.solo);
      channel.forEach(ch => {
        const sliderVal = parseFloat(ch.slider.value);
        const soloGate = anySolo ? (ch.solo ? 1 : 0) : 1;
        const muteGate = ch.muted ? 0 : 1;
        ch.gain.gain.value = sliderVal * soloGate * muteGate;
      });
    }

    async function ensureContext() {
      if (!audioContext) return;
      if (audioContext.state !== 'running') {
        try { await audioContext.resume(); } catch (e) {}
      }
    }

    async function playPause() {
      if (channel.length === 0) return; // nothing loaded
      await ensureContext();

      const btn = document.getElementById("play-pause");
      if (!isPlaying) {
        startTime = audioContext.currentTime - offset;
        sources = channel.map(ch => {
          const src = audioContext.createBufferSource();
          src.buffer = ch.buffer;
          src.connect(ch.gain).connect(audioContext.destination);
          src.start(0, offset);
          return src;
        });
        isPlaying = true;
        btn.textContent = "Pause";
        animateProgress();
      } else {
        // Pause
        offset = audioContext.currentTime - startTime;
        sources.forEach(src => { try { src.stop(); } catch(_){} });
        sources = [];
        isPlaying = false;
        btn.textContent = "Play";
      }
    }

    function stopAll() {
      // Stop and reset to start
      if (sources && sources.length) sources.forEach(src => { try { src.stop(); } catch(_){} });
      sources = [];
      isPlaying = false;
      offset = 0;
      startTime = audioContext ? audioContext.currentTime : 0;
      document.getElementById("play-pause").textContent = "Play";
      const bar = document.getElementById("progress-bar");
      if (bar) bar.style.left = "0px";
      document.getElementById("timer").textContent = "Measure 1, Beat 1";
    }

    function animateProgress() {
      const bar = document.getElementById("progress-bar");
      const update = () => {
        if (!isPlaying) return;
        const elapsed = audioContext.currentTime - startTime;
        const bps = tempoMap[0].bpm / 60;
        const totalBeats = elapsed * bps;
        const measure = Math.floor(totalBeats / tempoMap[0].beatsPerMeasure);
        const beat = Math.floor(totalBeats % tempoMap[0].beatsPerMeasure) + 1;
        document.getElementById("timer").textContent = `Measure ${measure + 1}, Beat ${beat}`;
        bar.style.left = `${measure * 34}px`;
        requestAnimationFrame(update);
      };
      update();
    }

    function drawTimeline() {
      const timeline = document.getElementById("timeline");
      const totalMeasures = Math.ceil((duration * (tempoMap[0].bpm / 60)) / tempoMap[0].beatsPerMeasure);
      for (let i = 0; i < totalMeasures; i++) {
        const tick = document.createElement("div");
        tick.className = "measure-tick";
        tick.innerHTML = `<span>${i + 1}</span>`;
        tick.onclick = () => jumpToMeasureIndex(i);
        timeline.appendChild(tick);
      }
    }

    function jumpToMeasure() {
      const m = parseInt(document.getElementById("jump-measure").value);
      if (!Number.isFinite(m) || m < 1) return;
      jumpToMeasureIndex(m - 1);
    }

    function jumpToMeasureIndex(measureIndex) {
      const secondsPerBeat = 60 / tempoMap[0].bpm;
      const time = measureIndex * tempoMap[0].beatsPerMeasure * secondsPerBeat;
      offset = time;
      // Restart from new position (acts like play)
      if (isPlaying) {
        sources.forEach(src => { try { src.stop(); } catch(_){} });
        sources = [];
      }
      playPause();
    }
  </script>
</body>
</html>
