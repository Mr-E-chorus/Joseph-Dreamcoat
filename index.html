<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Choir Practice Player</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 700px;
      margin: auto;
      padding: 20px;
    }
    div.track {
      margin-bottom: 15px;
    }
    label {
      display: inline-block;
      width: 120px; /* extra space so sliders don't overlap names */
    }
    input[type=range] {
      width: 200px;
    }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      cursor: pointer;
    }
    #player, #track-title, #timer, #timeline, #jump-controls, #main-controls {
      display: none;
    }
    #access-denied {
      color: red;
      font-weight: bold;
      display: none;
    }
    #timer {
      margin-bottom: 15px;
      font-weight: bold;
      text-align: center;
    }
    #main-controls {
      text-align: center;
      margin-bottom: 20px;
    }
    #play-pause {
      background-color: green;
      color: white;
      border: none;
      margin-right: 10px;
    }
    #stop {
      background-color: red;
      color: white;
      border: none;
    }
    #timeline {
      margin: 20px 0;
      height: 40px;
      background-color: #eee;
      position: relative;
      overflow-x: auto;
      white-space: nowrap;
    }
    .measure-tick {
      display: inline-block;
      height: 100%;
      width: 30px;
      position: relative;
      border-left: 1px solid #ccc;
      cursor: pointer;
    }
    .measure-tick.highlight {
      background-color: #cde;
    }
    .measure-tick span {
      position: absolute;
      bottom: 0;
      left: 2px;
      font-size: 10px;
    }
    #progress-bar {
      position: absolute;
      top: 0;
      height: 100%;
      width: 2px;
      background-color: red;
    }
    #jump-controls {
      margin-bottom: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1 id="track-title">Close Every Door</h1>
  <div id="timer">Measure --, Beat --</div>

  <div id="main-controls">
    <button id="play-pause">Play</button>
    <button id="stop">Stop</button>
  </div>

  <div id="jump-controls">
    <label for="jump-measure">Jump to measure:</label>
    <input type="number" id="jump-measure" min="1" max="127" />
    <button onclick="jumpToMeasure()">Go</button>
  </div>
  <div id="timeline"><div id="progress-bar"></div></div>

  <div id="password-gate">
    <p>Enter password to access the choir tracks:</p>
    <input type="password" id="password-input" />
    <button onclick="checkPassword()">Submit</button>
    <p id="access-denied">Access Denied</p>
  </div>

  <div id="player"></div>

  <script>
    const correctPassword = "sing123";

    const tracks = [
      { name: 'Accompaniment', url: 'assets/Accompaniment Close Every Door.wav' },
      { name: 'Joseph', url: 'assets/Joseph Close Every Door.wav' },
      { name: 'S1', url: 'assets/S1 Close Every Door.wav' },
      { name: 'S2', url: 'assets/S2 Close Every Door.wav' },
      { name: 'Alto', url: 'assets/Alto Close Every Door.wav' },
      { name: 'Tenor', url: 'assets/Tenor Close Every Door.wav' },
      { name: 'Bass', url: 'assets/Bass Close Every Door.wav' },
      { name: 'Choir 1', url: 'assets/Choir 1 Close Every Door.wav' },
      { name: 'Choir 2', url: 'assets/Choir 2 Close Every Door.wav' }
    ];

    const tempoMap = [
      { measure: 0, beatsPerMeasure: 3, bpm: 80 }
    ];

    let audioContext;
    let sources = [];
    let gains = [];
    let startTime = 0;
    let isPlaying = false;
    let duration = 0;
    let offset = 0;

    function checkPassword() {
      const input = document.getElementById("password-input").value;
      const gate = document.getElementById("password-gate");
      const denied = document.getElementById("access-denied");
      if (input === correctPassword) {
        gate.style.display = "none";
        document.getElementById("player").style.display = "block";
        document.getElementById("track-title").style.display = "block";
        document.getElementById("timer").style.display = "block";
        document.getElementById("timeline").style.display = "block";
        document.getElementById("jump-controls").style.display = "block";
        document.getElementById("main-controls").style.display = "block";
        document.getElementById("play-pause").disabled = true;
        document.getElementById("stop").disabled = true;
        initPlayer();
      } else {
        denied.style.display = "block";
      }
    }

    async function initPlayer() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const playerDiv = document.getElementById("player");
      for (const track of tracks) {
        const div = document.createElement("div");
        div.className = "track";
        const label = document.createElement("label");
        label.textContent = track.name;
        const slider = document.createElement("input");
        slider.type = "range";
        slider.min = 0;
        slider.max = 1;
        slider.step = 0.01;
        slider.value = 1;

        // Solo and Mute
        const soloBtn = document.createElement("button");
        soloBtn.textContent = "Solo";
        soloBtn.onclick = () => soloTrack(track.name);
        const muteBtn = document.createElement("button");
        muteBtn.textContent = "Mute";
        muteBtn.onclick = () => muteTrack(track.name);

        div.appendChild(label);
        div.appendChild(slider);
        div.appendChild(soloBtn);
        div.appendChild(muteBtn);
        playerDiv.appendChild(div);

        const response = await fetch(track.url);
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

        const gainNode = audioContext.createGain();
        gainNode.gain.value = slider.value;
        slider.oninput = () => gainNode.gain.value = slider.value;
        gains.push({ name: track.name, buffer: audioBuffer, gain: gainNode });
        duration = Math.max(duration, audioBuffer.duration);
      }
      drawTimeline();
      document.getElementById("play-pause").disabled = false;
      document.getElementById("stop").disabled = false;
      document.getElementById("play-pause").addEventListener("click", playPause);
      document.getElementById("stop").addEventListener("click", stopAll);
    }

    function soloTrack(name) {
      gains.forEach(track => {
        track.gain.gain.value = (track.name === name) ? 1 : 0;
      });
    }

    function muteTrack(name) {
      gains.forEach(track => {
        if (track.name === name) track.gain.gain.value = 0;
      });
    }

    function playPause() {
      if (!isPlaying) {
        startTime = audioContext.currentTime - offset;
        sources = gains.map(({ buffer, gain }) => {
          const source = audioContext.createBufferSource();
          source.buffer = buffer;
          source.connect(gain).connect(audioContext.destination);
          source.start(0, offset);
          return source;
        });
        isPlaying = true;
        document.getElementById("play-pause").textContent = "Pause";
        animateProgress();
      } else {
        sources.forEach(source => source.stop());
        offset = audioContext.currentTime - startTime;
        isPlaying = false;
        document.getElementById("play-pause").textContent = "Play";
      }
    }

    function stopAll() {
      if (sources.length) {
        sources.forEach(src => { try { src.stop(); } catch(_){} });
      }
      sources = [];
      isPlaying = false;
      offset = 0;
      startTime = audioContext.currentTime;
      document.getElementById("play-pause").textContent = "Play";
      document.getElementById("progress-bar").style.left = "0px";
      document.getElementById("timer").textContent = "Measure 1, Beat 1";
    }

    function animateProgress() {
      const bar = document.getElementById("progress-bar");
      const update = () => {
        if (!isPlaying) return;
        const elapsed = audioContext.currentTime - startTime;
        const totalBeats = elapsed * (tempoMap[0].bpm / 60);
        const measure = Math.floor(totalBeats / tempoMap[0].beatsPerMeasure);
        const beat = Math.floor(totalBeats % tempoMap[0].beatsPerMeasure) + 1;
        document.getElementById("timer").textContent = `Measure ${measure + 1}, Beat ${beat}`;
        bar.style.left = `${measure * 30}px`;
        requestAnimationFrame(update);
      };
      update();
    }

    function drawTimeline() {
      const timeline = document.getElementById("timeline");
      const totalMeasures = Math.ceil((duration * tempoMap[0].bpm / 60) / tempoMap[0].beatsPerMeasure);
      for (let i = 0; i < totalMeasures; i++) {
        const tick = document.createElement("div");
        tick.className = "measure-tick";
        tick.innerHTML = `<span>${i + 1}</span>`;
        tick.onclick = () => jumpToMeasure(i);
        timeline.appendChild(tick);
      }
    }

    function jumpToMeasure(measureIndex) {
      if (isNaN(measureIndex)) {
        measureIndex = parseInt(document.getElementById("jump-measure").value) - 1;
      }
      if (measureIndex < 0) return;
      sources.forEach(source => source.stop());
      const time = (measureIndex * tempoMap[0].beatsPerMeasure) / (tempoMap[0].bpm / 60);
      offset = time;
      playPause();
    }
  </script>
</body>
</html>
