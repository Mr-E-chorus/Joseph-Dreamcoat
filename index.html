<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Choir Practice Player</title>
  <style>
    :root {
      --gap: 12px;
      --label-width: 180px;
      --row-padding: 8px 10px;
      --radius: 10px;
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 20px;
      line-height: 1.4;
    }
    .stack { display: flex; flex-direction: column; gap: var(--gap); }

    /* Header & utility */
    #track-title { margin: 0 0 8px; }
    #timer { font-weight: 600; }

    /* Player rows */
    .track {
      display: flex;
      align-items: center;
      gap: var(--gap);
      padding: var(--row-padding);
      border: 1px solid #e5e7eb;
      border-radius: var(--radius);
      background: #fafafa;
    }
    .track label {
      min-width: var(--label-width);
      max-width: var(--label-width);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 600;
    }
    .track .slider-wrap { flex: 1; }
    .track input[type=range] { width: 100%; }

    /* Buttons */
    .btn {
      border: 1px solid #d1d5db;
      background: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .btn:hover { background: #f3f4f6; }
    .btn.active { border-color: #2563eb; background: #e0ecff; }
    .btn.mute.active { border-color: #dc2626; background: #ffe2e2; }

    /* Layout bits */
    #controls-bar { display: flex; align-items: center; gap: var(--gap); }
    #play-pause { padding: 10px 16px; font-size: 1rem; }

    /* Hidden until login */
    #player, #play-pause, #track-title, #timer, #timeline, #jump-controls { display: none; }
    #access-denied { color: red; font-weight: bold; display: none; }

    /* Timeline */
    #timeline { margin: 12px 0 20px; height: 44px; background: #f3f4f6; position: relative; overflow-x: auto; white-space: nowrap; border: 1px solid #e5e7eb; border-radius: var(--radius); }
    .measure-tick { display: inline-block; height: 100%; width: 34px; position: relative; border-left: 1px solid #e5e7eb; cursor: pointer; }
    .measure-tick.highlight { background-color: #eef6ff; }
    .measure-tick span { position: absolute; bottom: 2px; left: 4px; font-size: 10px; color: #374151; }
    #progress-bar { position: absolute; top: 0; height: 100%; width: 2px; background-color: #ef4444; }

    #jump-controls { display: none; margin-bottom: 14px; }
    #jump-controls input { width: 90px; }

    /* Responsive */
    @media (max-width: 640px) {
      :root { --label-width: 120px; }
      .track { flex-wrap: wrap; }
      .track label { flex: 1 1 100%; max-width: 100%; }
      .track .slider-wrap { flex: 1 1 100%; }
    }
  </style>
</head>
<body>
  <h1 id="track-title">Close Every Door</h1>
  <div class="stack">
    <div id="timer">Measure --, Beat --</div>

    <div id="controls-bar">
      <button id="play-pause" class="btn">Play / Pause</button>
      <div id="jump-controls">
        <label for="jump-measure">Jump to measure:</label>
        <input type="number" id="jump-measure" min="1" max="127" />
        <button class="btn" onclick="jumpToMeasure()">Go</button>
      </div>
    </div>

    <div id="timeline"><div id="progress-bar"></div></div>
  </div>

  <div id="password-gate">
    <p>Enter password to access the choir tracks:</p>
    <input type="password" id="password-input" />
    <button class="btn" onclick="checkPassword()">Submit</button>
    <p id="access-denied">Access Denied</p>
  </div>

  <div id="player" class="stack"></div>

  <script>
    const correctPassword = "sing123";

    const tracks = [
      { name: 'Accompaniment', url: 'assets/Accompaniment Close Every Door.wav' },
      { name: 'Joseph',        url: 'assets/Joseph Close Every Door.wav' },
      { name: 'S1',            url: 'assets/S1 Close Every Door.wav' },
      { name: 'S2',            url: 'assets/S2 Close Every Door.wav' },
      { name: 'Alto',          url: 'assets/Alto Close Every Door.wav' },
      { name: 'Tenor',         url: 'assets/Tenor Close Every Door.wav' },
      { name: 'Bass',          url: 'assets/Bass Close Every Door.wav' },
      { name: 'Choir 1',       url: 'assets/Choir 1 Close Every Door.wav' },
      { name: 'Choir 2',       url: 'assets/Choir 2 Close Every Door.wav' }
    ];

    const tempoMap = [ { measure: 0, beatsPerMeasure: 3, bpm: 80 } ];

    let audioContext;
    let sources = [];
    let channel = []; // {buffer, gain, slider, muteBtn, soloBtn, muted, solo}
    let startTime = 0;
    let isPlaying = false;
    let duration = 0;

    function checkPassword() {
      const input = document.getElementById("password-input").value;
      const gate = document.getElementById("password-gate");
      const denied = document.getElementById("access-denied");
      if (input === correctPassword) {
        gate.style.display = "none";
        document.getElementById("player").style.display = "flex";
        document.getElementById("play-pause").style.display = "inline-block";
        document.getElementById("track-title").style.display = "block";
        document.getElementById("timer").style.display = "block";
        document.getElementById("timeline").style.display = "block";
        document.getElementById("jump-controls").style.display = "block";
        initPlayer();
      } else {
        denied.style.display = "block";
      }
    }

    async function initPlayer() {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const playerDiv = document.getElementById("player");

      for (const track of tracks) {
        // UI row
        const row = document.createElement("div");
        row.className = "track";
        const label = document.createElement("label");
        label.textContent = track.name;
        const sliderWrap = document.createElement("div");
        sliderWrap.className = "slider-wrap";
        const slider = document.createElement("input");
        slider.type = "range"; slider.min = 0; slider.max = 1; slider.step = 0.01; slider.value = 1;
        sliderWrap.appendChild(slider);
        const muteBtn = document.createElement("button");
        muteBtn.className = "btn mute"; muteBtn.textContent = "Mute";
        const soloBtn = document.createElement("button");
        soloBtn.className = "btn solo"; soloBtn.textContent = "Solo";
        row.append(label, sliderWrap, muteBtn, soloBtn);
        playerDiv.appendChild(row);

        // Audio nodes
        const response = await fetch(track.url);
        const arrayBuffer = await response.arrayBuffer();
        const buffer = await audioContext.decodeAudioData(arrayBuffer);
        const gain = audioContext.createGain();
        gain.gain.value = parseFloat(slider.value);

        const ch = { buffer, gain, slider, muteBtn, soloBtn, muted: false, solo: false };
        channel.push(ch);
        duration = Math.max(duration, buffer.duration);

        // Wiring UI
        slider.addEventListener('input', () => updateMix());
        muteBtn.addEventListener('click', () => { ch.muted = !ch.muted; muteBtn.classList.toggle('active', ch.muted); updateMix(); });
        soloBtn.addEventListener('click', () => { ch.solo = !ch.solo; soloBtn.classList.toggle('active', ch.solo); updateMix(); });
      }

      drawTimeline();
      updateMix();
      document.getElementById("play-pause").addEventListener("click", playPause);
    }

    function updateMix() {
      const anySolo = channel.some(ch => ch.solo);
      channel.forEach(ch => {
        const sliderVal = parseFloat(ch.slider.value);
        const soloGate = anySolo ? (ch.solo ? 1 : 0) : 1;
        const muteGate = ch.muted ? 0 : 1;
        ch.gain.gain.value = sliderVal * soloGate * muteGate;
      });
    }

    function playPause() {
      if (!isPlaying) {
        startTime = audioContext.currentTime;
        sources = channel.map(ch => {
          const src = audioContext.createBufferSource();
          src.buffer = ch.buffer;
          src.connect(ch.gain).connect(audioContext.destination);
          src.start();
          return src;
        });
        isPlaying = true;
        animateProgress();
      } else {
        sources.forEach(src => src.stop());
        isPlaying = false;
      }
    }

    function animateProgress() {
      const bar = document.getElementById("progress-bar");
      const update = () => {
        if (!isPlaying) return;
        const elapsed = audioContext.currentTime - startTime;
        const beatsPerSecond = tempoMap[0].bpm / 60;
        const totalBeats = elapsed * beatsPerSecond;
        const measure = Math.floor(totalBeats / tempoMap[0].beatsPerMeasure);
        const beat = Math.floor(totalBeats % tempoMap[0].beatsPerMeasure) + 1;
        document.getElementById("timer").textContent = `Measure ${measure + 1}, Beat ${beat}`;
        bar.style.left = `${measure * 34}px`;
        requestAnimationFrame(update);
      };
      update();
    }

    function drawTimeline() {
      const timeline = document.getElementById("timeline");
      const totalMeasures = Math.ceil((duration * (tempoMap[0].bpm / 60)) / tempoMap[0].beatsPerMeasure);
      for (let i = 0; i < totalMeasures; i++) {
        const tick = document.createElement("div");
        tick.className = "measure-tick";
        tick.innerHTML = `<span>${i + 1}</span>`;
        tick.onclick = () => jumpToMeasureIndex(i);
        timeline.appendChild(tick);
      }
    }

    function jumpToMeasure() {
      const m = parseInt(document.getElementById("jump-measure").value);
      if (Number.isNaN(m) || m < 1) return;
      jumpToMeasureIndex(m - 1);
    }

    function jumpToMeasureIndex(measureIndex) {
      // stop current
      sources.forEach(src => src.stop());
      const secondsPerBeat = 60 / tempoMap[0].bpm;
      const time = measureIndex * tempoMap[0].beatsPerMeasure * secondsPerBeat;
      startTime = audioContext.currentTime - time;
      sources = channel.map(ch => {
        const src = audioContext.createBufferSource();
        src.buffer = ch.buffer;
        src.connect(ch.gain).connect(audioContext.destination);
        src.start(0, time);
        return src;
      });
      isPlaying = true;
      updateMix();
      animateProgress();
    }
  </script>
</body>
</html>
